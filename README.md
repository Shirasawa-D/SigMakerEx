转至: https://github.com/kweatherman/sigmakerex

## SigMakerEx

增强型 IDA Pro 签名生成器插件。

### 安装

复制 `IDA_SigMaker32.dLL` 和 `IDA_SigMaker64.dLL` 到您的 IDA `plugins` 目录。

IDA 的默认热键是 “Ctrl-Alt-S”，但可以使用您的 IDA “plugins.cfg ”设置为另一个热键。
由于 “Ctrl-Alt-S ”现在与 IDA 默认组合键相冲突，为避免收到警告信息，请编辑 “idagui.cfg ”并将 “StackTrace ”条目设置为 “StackTrace“ = 0 // ”Ctrl-Alt-S“ // 打开堆栈跟踪窗口`（”0 "禁用该键）。

需要 IDA Pro 7.6'ish 版本。

### 使用
通过热键或 IDA 编辑/插件菜单调用插件。

![main](/images/main.png)

有三种签名生成操作：
 1. **Function**: 根据 *Options* 配置（见下文），用于创建唯一的函数入口点、带偏移的最小函数签名或整体签名。

    首先选择目标函数内的任意地址。
    如果所选函数不唯一（对于入口点或最小选项），则将尝试唯一函数交叉引用扫描签名。

    典型用例 签名用于在运行时定位目标内存中的函数，在可执行文件更新后定位 IDA 中的函数，或通过签名帮助定位已知库等。


2) **At address**: 尝试在所选地址查找唯一签名。
典型用例： 用于在运行时定位特定偏移以便挂钩，或为此制作 [Cheat Engine](https://www.cheatengine.org/) 脚本签名等。

3. **From address range**: 从所选地址范围生成签名，不检查唯一性。
    当其他操作无法正常工作时的特殊用例。如希望忽略签名的唯一性等。 

签名输出示例：
![minimal_func_example](/images/minimal_func_example.png)

签名结果会被推送到 Windows 剪贴板，便于 CTRL+V 粘贴到源代码等。

##### Options

![options](/images/options.png)

**Output format:**
**IDA**: IDA 和其他一些工具支持的默认十六进制二进制搜索格式，使用间隔十六进制字节和“?? ”通配符。
示例： `C1 6C E8 ? ?? ?? ?? 8B 50 08`
**Code style**: Escape 编码的十六进制字符串和单独的掩码字符串，其中 “x ”表示保留字节，”?
示例: `"\xC1\x6C\xE8\xCC\xCC\xCC\xCC\x8B\x50\x08", "xxx????xxx"`
**Inline byte**: 简约的 C 风格字节数组，包含通配符字节格式。
示例: `{0xC1,0x6C,0xE8,0xAE,0xAE,0xAE,0xAE,0x8B,0x50,0x08};`
使用 “屏蔽字节 ”编辑框更改默认的 “内联字节 ”屏蔽字节。
默认掩码字节为 “0xAE”，是使用最少的代码字节之一（见下文 “理想掩码字节”）。

##### Function sigs: 

功能 "签名生成的标准。
**Entry point**: 在可能的情况下，将尝试生成最小字节大小的函数入口点签名。
**Minimal byte size**: 将尝试在所选函数体内部生成一个最小、通配符数最少、字节大小（大于 5 个）的指令边界对齐签名。
**Full function body**: 将尝试生成唯一的全功能主体签名。

对于这三个选项中的任何一个，如果函数不是唯一的，将尝试查找最小的唯一交叉引用签名。如果您希望为非唯一函数制作完整或部分函数签名，请使用 “从地址范围 ”选项。

**Message level**: 设置为 “Verbose（详细）”可将内部签名生成信息输出到 IDA 日志窗口。

**Max function scan refs**: 当找不到直接的 “Function”（功能）操作签名时，限制搜索功能交叉引用的数量。通常情况下，该值应为 “0”，表示无限制搜索，但如果出现引用过多导致速度变慢的问题，则可将该值设置为某个合理的限制（如 16 或 100），以提高扫描速度。

对于相对罕见的函数，如果函数块分布在多个地址范围内，工具将尝试只使用第一个函数块。如果希望在其中一个不相连的块中制作签名，请尝试使用 “在地址处 ”方法。如果其他方法都无效，可尝试使用 “从地址范围 ”签名（可能需要手动搜索以确保唯一性）。

**Max function entry point signature bytes**: 使用 “功能 ”选项并配置 “入口点 ”标准时，可选择限制入口点签名的最大字节大小。默认值为 “0”，表示无限制（最多可达到整个选定功能体的字节大小）。
如果超过此限制，则将查找交叉引用签名。

设置为 “16 ”或 “32 ”这样的实用限制，以便优先选择通常较小的 xref 签名和可能很大的入口点签名。

### Original SigMaker vs SigMakerEx 

1. SigMakerEx (“EX”) 通过更好的指令分析，可以生成更小、更紧凑的函数签名。
   例如 SigMaker (“SM”) 对指令 `sub esp, 90h`（即 `"81 EC ?? ?? ?? ?`）的操作数字节进行通配符处理，不必要地丢弃了最后四个字节。而 EX 将其视为立即值，并保留整个 `81 EC 90 00 00 00` 字节序列。
2. EX 更侧重于规范功能体签名用例。
   对于 SM，只有一个可控选项。无论您在函数中选择了哪个地址，它都会尝试在该地址制作一个唯一的签名。如果找不到，它将只寻找唯一的交叉引用签名。
   在 EX 中，由于确定的典型用例是查找函数入口点，因此当配置 “入口点 ”标准选项时，将生成最小的入口点签名。
   而当选择 “最小字节大小 ”选项时，将在整个函数体中查找最小且通配符数最少的唯一签名（最少 5 个字节）。
3. SM 在选项对话框中对字节数和通配符数等输出标准有更多控制。EX 假设您想要两者兼得（最少通配符和最小字节大小）。
4. EX 省略了 SM 所具有的 “转换 ”和单独的 “搜索 ”功能，而更倾向于使用更简单、不那么杂乱的用户界面。

   在搜索时，由于 EX 除了选择输出格式签名外，还总是输出 IDA 格式，因此请使用 IDA 二进制搜索 “Hex ”选项和 IDA sig 字符串。
5. 由于采用了将 IDB 克隆到 RAM 中并使用 AVX2 优化模式扫描器的技术，而不是依赖速度较慢的 IDA 查找功能进行扫描，因此 EX 的速度通常更快，甚至在进行更广泛的搜索时也是如此。                                                                          

### Ideal mask byte

在我自己的动态查找模式项目中，我更喜欢 “内联字节”（没有更好的名称）格式。
它是最简单、最紧凑的格式，而且不需要在运行时对 ASCII 十六进制字符串进行转换。
我在很多项目中都使用过这种格式，还没有遇到过任何签名碰撞或冗余匹配的问题。

为了尽量减少潜在的冗余问题，通配符/掩码字节最好使用最不常用的代码字节值。为了找到理想的候选值，我收集了三个 32 位和 64 位代码段的代码字节频率，然后将结果列表并排序。ida_get_byte_frequency.py "IDA 脚本用于收集字节频率字典并将其保存到 JSON DB。byte_frequency_tabulate.py "脚本对这些保存的 JSON 数据库进行制表和升序排序。
显然，32 位的字节频率与 64 位的字节频率并不相同，而且是独立制表的。请参见 “32bit.txt ”和 “64bit.txt”。
在两者的直观对比中，0xA2 实际上是最小公分母，其次是 0xAE。
之所以选择 0xAE 而不是 0xA2 作为默认屏蔽字节，是因为主观上它更容易用十六进制直观地识别出来。

### Building

在 Windows 10 上使用 Visual Studio 2019 构建，唯一依赖的是官方 IDA Pro C/C++ SDK。
在项目文件中进行设置时，它会查找环境变量 `_IDADIR`，并期望从中找到 IDA SDK 所在的 “idasdk/include ”和 “idasdk/lib ”文件夹。不使用 `IDADIR`，因为 IDA 会自己查找它，如果您尝试使用多个已安装的 IDA 版本，可能会导致冲突。

Python 3.7 或更高版本，以运行 “byte_frequency_tabulate.py ”脚本。

### Credits

感谢从 gamedeception.net 时代就开始使用 SigMaker 工具的创建者，直到现在的 C/C++ 和 Python 版本的作者：  P4TR！CK、bobbysing、xero|hawk、ajkhoury 和 zoomgod 等人。
感谢 Wojciech Mula 提供的 SIMD 编程资源。

### License

Released under MIT © 2022 By Kevin Weatherman
